name: back testing and push to dockerhub with front
on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  testjava:

    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
    - uses: actions/checkout@v4
    - name: Set up JDK 21
      uses: actions/setup-java@v4
      with:
        java-version: '21'
        distribution: 'temurin'

    - name: Setup Gradle
      uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0

    - name: Run tests
      run: cd studyup && ./gradlew test # <- esta parte corre los test unitarios 
      
    - name: Upload test report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-report
        path: studyup/build/reports/tests/test

  docker-build-back:
      runs-on: ubuntu-latest
      needs: testjava   # ðŸ”¹ solo corre si el job anterior fue exitoso âœ…
      steps:
        - uses: actions/checkout@v4
    
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3
          
        - name: Log in to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}
            
        - name: Build Docker image
          uses: docker/build-push-action@v6
          with:
            context: ./studyup
            file: ./studyup/Dockerfile
            push: true
            tags: ${{ secrets.DOCKERHUB_USERNAME }}/upstudy-backend:latest

  docker-build-front:
      runs-on: ubuntu-latest
      steps:
        - uses: actions/checkout@v4
    
        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3
          
        - name: Log in to Docker Hub
          uses: docker/login-action@v3
          with:
            username: ${{ secrets.DOCKERHUB_USERNAME }}
            password: ${{ secrets.DOCKERHUB_TOKEN }}
            
        - name: Build Docker image
          uses: docker/build-push-action@v6
          with:
            context: ./up_study_app
            file: ./up_study_app/Dockerfile
            push: true
            tags: ${{ secrets.DOCKERHUB_USERNAME }}/upstudy-frontend:latest

  
